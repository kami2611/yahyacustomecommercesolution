<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Admin</title>
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .order-header h1 {
      font-size: 1.5rem;
      color: #333;
      margin: 0;
    }
    
    .order-header .order-number {
      color: #6b2d5b;
    }
    
    .btn-back {
      padding: 10px 20px;
      background: #f5f5f5;
      color: #333;
      text-decoration: none;
      border-radius: 6px;
    }
    
    .order-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 25px;
    }
    
    @media (min-width: 1024px) {
      .order-grid {
        grid-template-columns: 2fr 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 25px;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin: 0 0 20px 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    /* Status Progress */
    .status-progress {
      margin-bottom: 30px;
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 10px;
    }
    
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 3px;
      background: #eee;
      z-index: 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    
    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .progress-step.completed .step-icon {
      background: #4caf50;
      color: white;
    }
    
    .progress-step.current .step-icon {
      background: #6b2d5b;
      color: white;
    }
    
    .progress-step.cancelled .step-icon {
      background: #f44336;
      color: white;
    }
    
    .step-label {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
    }
    
    .progress-step.completed .step-label,
    .progress-step.current .step-label {
      color: #333;
      font-weight: 500;
    }
    
    /* Status Update Form */
    .status-form {
      background: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }
    
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .btn-update {
      padding: 12px 24px;
      background: #6b2d5b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .btn-update:hover {
      background: #5a2550;
    }
    
    /* Order Items */
    .order-items {
      margin-bottom: 20px;
    }
    
    .order-item {
      display: flex;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #eee;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: #f5f5f5;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 5px;
    }
    
    .item-meta {
      font-size: 0.85rem;
      color: #666;
    }
    
    .item-total {
      font-weight: 600;
      color: #333;
      white-space: nowrap;
    }
    
    /* Order Summary */
    .order-summary {
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    
    .summary-row.total {
      font-weight: 600;
      font-size: 1.1rem;
      color: #333;
      padding-top: 10px;
      border-top: 1px solid #eee;
      margin-top: 10px;
    }
    
    /* Customer Info */
    .info-group {
      margin-bottom: 15px;
    }
    
    .info-label {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .info-value {
      color: #333;
    }
    
    /* Status History */
    .status-history {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .history-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }
    
    .history-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }
    
    .history-item .time {
      color: #888;
      white-space: nowrap;
    }
    
    .history-item .status {
      font-weight: 500;
      color: #333;
    }
    
    .history-item .note {
      color: #666;
    }
    
    .current-status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 20px;
    }
    
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-confirmed { background: #e3f2fd; color: #1565c0; }
    .status-processing { background: #f3e5f5; color: #7b1fa2; }
    .status-shipped { background: #e8f5e9; color: #2e7d32; }
    .status-out-for-delivery { background: #fff8e1; color: #f57f17; }
    .status-delivered { background: #e8f5e9; color: #1b5e20; }
    .status-cancelled { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <nav class="admin-nav">
    <div class="nav-brand">
      <a href="/admin">Admin Panel</a>
    </div>
    <ul class="nav-links">
      <li><a href="/admin/homepage">Homepage</a></li>
      <li><a href="/admin/categories">Categories</a></li>
      <li><a href="/admin/products">Products</a></li>
      <li><a href="/admin/orders" class="active">Orders</a></li>
      <li><a href="/admin/announcements">Announcements</a></li>
      <li><a href="/" target="_blank">View Shop</a></li>
      <li><a href="/admin/logout" class="logout-link">Logout</a></li>
    </ul>
  </nav>
  
  <main class="admin-content">
    <div class="order-header">
      <div>
        <h1>Order <span class="order-number"><%= order.orderNumber %></span></h1>
        <p style="color: #666; margin: 5px 0 0 0;">
          Placed on <%= new Date(order.createdAt).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
        </p>
      </div>
      <a href="/admin/orders" class="btn-back">‚Üê Back to Orders</a>
    </div>
    
    <% if (order.status !== 'cancelled') { %>
    <div class="card status-progress">
      <div class="progress-steps">
        <% 
          const steps = [
            { status: 'pending', label: 'Order Placed', icon: 'üìã' },
            { status: 'confirmed', label: 'Confirmed', icon: '‚úì' },
            { status: 'processing', label: 'Processing', icon: 'üì¶' },
            { status: 'shipped', label: 'Shipped', icon: 'üöö' },
            { status: 'out-for-delivery', label: 'Out for Delivery', icon: 'üèÉ' },
            { status: 'delivered', label: 'Delivered', icon: '‚úì' }
          ];
          const currentIndex = steps.findIndex(s => s.status === order.status);
        %>
        <% steps.forEach((step, index) => { %>
          <div class="progress-step <%= index < currentIndex ? 'completed' : '' %> <%= index === currentIndex ? 'current' : '' %>">
            <div class="step-icon"><%= step.icon %></div>
            <div class="step-label"><%= step.label %></div>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>
    
    <div class="order-grid">
      <div>
        <!-- Order Items -->
        <div class="card">
          <h2 class="card-title">Order Items</h2>
          <div class="order-items">
            <% order.items.forEach(item => { %>
              <div class="order-item">
                <div class="item-image">
                  <img src="<%= item.image || '/images/placeholder.png' %>" alt="<%= item.name %>">
                </div>
                <div class="item-details">
                  <div class="item-name"><%= item.name %></div>
                  <div class="item-meta">Rs <%= item.price.toLocaleString() %> √ó <%= item.quantity %></div>
                </div>
                <div class="item-total">Rs <%= item.total.toLocaleString() %></div>
              </div>
            <% }) %>
          </div>
          
          <div class="order-summary">
            <div class="summary-row">
              <span>Subtotal</span>
              <span>Rs <%= order.subtotal.toLocaleString() %></span>
            </div>
            <div class="summary-row">
              <span>Delivery</span>
              <span><%= order.deliveryFee > 0 ? 'Rs ' + order.deliveryFee.toLocaleString() : 'FREE' %></span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span>Rs <%= order.total.toLocaleString() %></span>
            </div>
          </div>
        </div>
        
        <!-- Update Status -->
        <div class="card" style="margin-top: 25px;">
          <h2 class="card-title">Update Status</h2>
          <form class="status-form" id="status-form">
            <div class="form-row">
              <div class="form-group">
                <label>Status</label>
                <select name="status" id="status-select">
                  <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                  <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                  <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                  <option value="out-for-delivery" <%= order.status === 'out-for-delivery' ? 'selected' : '' %>>Out for Delivery</option>
                  <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                  <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tracking Number</label>
                <input type="text" name="trackingNumber" value="<%= order.trackingNumber || '' %>" placeholder="Enter tracking number">
              </div>
            </div>
            <div class="form-group">
              <label>Estimated Delivery</label>
              <input type="date" name="estimatedDelivery" value="<%= order.estimatedDelivery ? new Date(order.estimatedDelivery).toISOString().split('T')[0] : '' %>">
            </div>
            <div class="form-group">
              <label>Note</label>
              <textarea name="note" rows="2" placeholder="Add a note about this status update"></textarea>
            </div>
            <button type="submit" class="btn-update">Update Status</button>
          </form>
        </div>
      </div>
      
      <div>
        <!-- Current Status -->
        <div class="card">
          <h2 class="card-title">Order Status</h2>
          <span class="current-status status-<%= order.status %>">
            <%= order.status.charAt(0).toUpperCase() + order.status.slice(1).replace(/-/g, ' ') %>
          </span>
          
          <% if (order.trackingNumber) { %>
            <div class="info-group">
              <div class="info-label">Tracking Number</div>
              <div class="info-value"><%= order.trackingNumber %></div>
            </div>
          <% } %>
          
          <% if (order.estimatedDelivery) { %>
            <div class="info-group">
              <div class="info-label">Estimated Delivery</div>
              <div class="info-value"><%= new Date(order.estimatedDelivery).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) %></div>
            </div>
          <% } %>
          
          <% if (order.statusHistory && order.statusHistory.length > 0) { %>
            <div class="status-history">
              <div class="history-title">Status History</div>
              <% order.statusHistory.slice().reverse().forEach(history => { %>
                <div class="history-item">
                  <span class="time"><%= new Date(history.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></span>
                  <div>
                    <span class="status"><%= history.status.charAt(0).toUpperCase() + history.status.slice(1).replace(/-/g, ' ') %></span>
                    <% if (history.note) { %>
                      <div class="note"><%= history.note %></div>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
        
        <!-- Customer Info -->
        <div class="card" style="margin-top: 25px;">
          <h2 class="card-title">Customer Details</h2>
          <div class="info-group">
            <div class="info-label">Name</div>
            <div class="info-value"><%= order.customer.fullName %></div>
          </div>
          <div class="info-group">
            <div class="info-label">Email</div>
            <div class="info-value"><%= order.customer.email %></div>
          </div>
          <div class="info-group">
            <div class="info-label">Phone</div>
            <div class="info-value"><%= order.customer.phone %></div>
          </div>
          <div class="info-group">
            <div class="info-label">Address</div>
            <div class="info-value">
              <%= order.customer.address %><br>
              <%= order.customer.city %><% if (order.customer.postalCode) { %>, <%= order.customer.postalCode %><% } %>
            </div>
          </div>
          <% if (order.notes) { %>
            <div class="info-group">
              <div class="info-label">Order Notes</div>
              <div class="info-value"><%= order.notes %></div>
            </div>
          <% } %>
        </div>
        
        <!-- Payment Info -->
        <div class="card" style="margin-top: 25px;">
          <h2 class="card-title">Payment</h2>
          <div class="info-group">
            <div class="info-label">Method</div>
            <div class="info-value"><%= order.paymentMethod %></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    document.getElementById('status-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/admin/orders/<%= order._id %>/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          window.location.reload();
        } else {
          alert(result.message || 'Error updating status');
        }
      } catch (error) {
        alert('Error updating status');
      }
    });
  </script>
</body>
</html>
