<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('../partials/seo-head') %>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/home.css">
  <link rel="stylesheet" href="/css/product.css">
  <script src="/js/theme.js"></script>
</head>
<body>
 <%- include('../partials/header') %>
 
  <%- include('../partials/mega-nav') %>
  
  <main class="product-page">
    <!-- Breadcrumbs -->
    <div class="container">
      <%- include('../partials/breadcrumbs', { breadcrumbs: breadcrumbs }) %>
    </div>
    
    <!-- Product Detail Section -->
    <section class="product-detail">
      <div class="container">
        <div class="product-detail-grid">
          <!-- Image Carousel -->
          <div class="product-gallery">
            <div class="gallery-main">
              <button class="gallery-nav gallery-prev" aria-label="Previous image">â€¹</button>
              <div class="gallery-images">
                <% if (product.images && product.images.length > 0) { %>
                  <% product.images.forEach((img, index) => { %>
                    <div class="gallery-slide <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>">
                      <img src="<%= img %>" alt="<%= product.name %> - Image <%= index + 1 %>" 
                           onerror="this.src='/images/placeholder.png'">
                    </div>
                  <% }) %>
                <% } else { %>
                  <div class="gallery-slide active" data-index="0">
                    <img src="/images/placeholder.png" alt="<%= product.name %>">
                  </div>
                <% } %>
              </div>
              <button class="gallery-nav gallery-next" aria-label="Next image">â€º</button>
            </div>
            
            <!-- Thumbnail Indicators -->
            <div class="gallery-indicators">
              <% if (product.images && product.images.length > 0) { %>
                <% product.images.forEach((img, index) => { %>
                  <button class="gallery-indicator <%= index === 0 ? 'active' : '' %>" 
                          data-index="<%= index %>" aria-label="Go to image <%= index + 1 %>">
                  </button>
                <% }) %>
              <% } else { %>
                <button class="gallery-indicator active" data-index="0"></button>
              <% } %>
            </div>
          </div>
          
          <!-- Product Info -->
          <div class="product-info">
            <h1 class="product-title"><%= product.name %></h1>
            
            <div class="product-price-section">
              <span class="product-price">Rs <%= product.price.toLocaleString() %></span>
              <% if (product.originalPrice && product.originalPrice > product.price) { %>
                <span class="product-original-price"><%= product.originalPrice.toLocaleString() %></span>
              <% } %>
            </div>
            
            <!-- Quantity Selector -->
            <div class="quantity-section">
              <label class="quantity-label">Quantity</label>
              <div class="quantity-selector">
                <button class="qty-btn qty-minus" type="button" aria-label="Decrease quantity">âˆ’</button>
                <input type="number" class="qty-input" value="1" min="1" max="<%= product.stock || 99 %>" id="product-qty">
                <button class="qty-btn qty-plus" type="button" aria-label="Increase quantity">+</button>
              </div>
            </div>
            
            <!-- Add to Cart Button -->
            <button class="btn-add-to-cart" 
                    data-product-id="<%= product._id %>"
                    data-product-name="<%= product.name %>"
                    data-product-price="<%= product.price %>"
                    data-product-image="<%= product.images && product.images.length > 0 ? product.images[0] : '/images/placeholder.png' %>"
                    onclick="addToCartFromData(this)">
              <span class="cart-icon">ðŸ›’</span>
              Add to Basket
            </button>
            
            <!-- Stock Status -->
            <div class="stock-status">
              <% if (product.stock > 0) { %>
                <span class="stock-available">
                  <span class="stock-icon">ðŸšš</span>
                  Available for home delivery
                </span>
              <% } else { %>
                <span class="stock-unavailable">Currently out of stock</span>
              <% } %>
            </div>
            
            <!-- Specifications (Expanded - No Accordion) -->
            <div class="product-specifications">
              <h3 class="specs-header">Specifications</h3>
              <% if (product.metadata && product.metadata.size > 0) { %>
                <table class="specs-table">
                  <tbody>
                    <% 
                      const metadataObj = product.metadata instanceof Map 
                        ? Object.fromEntries(product.metadata) 
                        : product.metadata;
                      Object.entries(metadataObj).forEach(([key, value]) => { 
                    %>
                      <tr>
                        <th><%= key %></th>
                        <td><%= value %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              <% } else { %>
                <p>No specifications available for this product.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Product Description Section (Expanded - No Accordion) -->
    <section class="product-description-section">
      <div class="container">
        <div class="product-description-content">
          <h3 class="description-header">Product Description</h3>
          <% if (product.description) { %>
            <p><%= product.description %></p>
          <% } else { %>
            <p>No description available for this product.</p>
          <% } %>
        </div>
      </div>
    </section>
    
    <!-- Similar Products Section -->
    <% if (similarProducts && similarProducts.length > 0) { %>
      <section class="product-section similar-products">
        <div class="container">
          <h2 class="section-title">Similar products</h2>
          <div class="products-carousel">
            <button class="carousel-nav-btn carousel-nav-prev" aria-label="Previous products">â€¹</button>
            <div class="products-carousel-track">
              <% similarProducts.forEach(item => { %>
                <div class="product-card">
                  <div class="product-card-image">
                    <a href="/product/<%= item.slug %>">
                      <img src="<%= item.images && item.images.length > 0 ? item.images[0] : '/images/placeholder.png' %>" 
                           alt="<%= item.name %>"
                           onerror="this.src='/images/placeholder.png'">
                    </a>
                   
                  </div>
                  <div class="product-card-info">
                    <h3 class="product-card-title">
                      <a href="/product/<%= item.slug %>"><%= item.name %></a>
                    </h3>
                    <div class="product-card-price">
                      <span class="price">Rs <%= item.price.toLocaleString() %></span>
                      <% if (item.originalPrice && item.originalPrice > item.price) { %>
                        <span class="original-price"><%= item.originalPrice.toLocaleString() %></span>
                      <% } %>
                    </div>
                    <button class="btn-add-to-cart-small" 
                            data-product-id="<%= item._id %>"
                            data-product-name="<%= item.name %>"
                            data-product-price="<%= item.price %>"
                            data-product-image="<%= item.images && item.images.length > 0 ? item.images[0] : '/images/placeholder.png' %>"
                            onclick="addToCartFromData(this)">
                      <span class="cart-icon">ðŸ›’</span>
                      Add to Basket
                    </button>
                  </div>
                </div>
              <% }) %>
            </div>
            <button class="carousel-nav-btn carousel-nav-next" aria-label="Next products">â€º</button>
          </div>
        </div>
      </section>
    <% } %>
    
    <!-- You May Also Like Section -->
    <% if (youMayAlsoLike && youMayAlsoLike.length > 0) { %>
      <section class="product-section you-may-like">
        <div class="container">
          <h2 class="section-title">You may also like</h2>
          <div class="products-carousel">
            <button class="carousel-nav-btn carousel-nav-prev" aria-label="Previous products">â€¹</button>
            <div class="products-carousel-track">
              <% youMayAlsoLike.forEach(item => { %>
                <div class="product-card">
                  <div class="product-card-image">
                    <a href="/product/<%= item.slug %>">
                      <img src="<%= item.images && item.images.length > 0 ? item.images[0] : '/images/placeholder.png' %>" 
                           alt="<%= item.name %>"
                           onerror="this.src='/images/placeholder.png'">
                    </a>
                    
                    <% if (item.originalPrice && item.originalPrice > item.price) { %>
                      <% const saveAmount = item.originalPrice - item.price; %>
                      <span class="save-badge">Save Rs <%= saveAmount.toLocaleString() %></span>
                    <% } %>
                  </div>
                  <div class="product-card-info">
                    <h3 class="product-card-title">
                      <a href="/product/<%= item.slug %>"><%= item.name %></a>
                    </h3>
                    <div class="product-card-price">
                      <span class="price">Rs <%= item.price.toLocaleString() %></span>
                      <% if (item.originalPrice && item.originalPrice > item.price) { %>
                        <span class="original-price"><%= item.originalPrice.toLocaleString() %></span>
                      <% } %>
                    </div>
                    <button class="btn-add-to-cart-small" 
                            data-product-id="<%= item._id %>"
                            data-product-name="<%= item.name %>"
                            data-product-price="<%= item.price %>"
                            data-product-image="<%= item.images && item.images.length > 0 ? item.images[0] : '/images/placeholder.png' %>"
                            onclick="addToCartFromData(this)">
                      <span class="cart-icon">ðŸ›’</span>
                      Add to Basket
                    </button>
                  </div>
                </div>
              <% }) %>
            </div>
            <button class="carousel-nav-btn carousel-nav-next" aria-label="Next products">â€º</button>
          </div>
        </div>
      </section>
    <% } %>
    
    <!-- Trustpilot Reviews Section -->
    <section class="trustpilot-section">
      <div class="container">
        <div class="trustpilot-widget">
          <div class="trustpilot-header">
            <span class="trustpilot-logo">â˜… Trustpilot</span>
            <div class="trustpilot-stars">
              <span class="star filled">â˜…</span>
              <span class="star filled">â˜…</span>
              <span class="star filled">â˜…</span>
              <span class="star filled">â˜…</span>
              <span class="star half">â˜…</span>
            </div>
            <span class="trustpilot-score">4.5 out of 5</span>
          </div>
          <p class="trustpilot-text">Based on 10,000+ reviews</p>
        </div>
      </div>
    </section>
  </main>
  
  <%- include('../partials/footer') %>
  
  <script>
    // Image Gallery
    document.addEventListener('DOMContentLoaded', function() {
      const gallerySlides = document.querySelectorAll('.gallery-slide');
      const indicators = document.querySelectorAll('.gallery-indicator');
      const prevBtn = document.querySelector('.gallery-prev');
      const nextBtn = document.querySelector('.gallery-next');
      let currentSlide = 0;
      const totalSlides = gallerySlides.length;
      
      function showSlide(index) {
        if (index < 0) index = totalSlides - 1;
        if (index >= totalSlides) index = 0;
        currentSlide = index;
        
        gallerySlides.forEach((slide, i) => {
          slide.classList.toggle('active', i === index);
        });
        indicators.forEach((indicator, i) => {
          indicator.classList.toggle('active', i === index);
        });
      }
      
      if (prevBtn) prevBtn.addEventListener('click', () => showSlide(currentSlide - 1));
      if (nextBtn) nextBtn.addEventListener('click', () => showSlide(currentSlide + 1));
      
      indicators.forEach(indicator => {
        indicator.addEventListener('click', () => {
          showSlide(parseInt(indicator.dataset.index));
        });
      });
      
      // Quantity Selector
      const qtyInput = document.getElementById('product-qty');
      const minusBtn = document.querySelector('.qty-minus');
      const plusBtn = document.querySelector('.qty-plus');
      
      if (minusBtn) {
        minusBtn.addEventListener('click', () => {
          const val = parseInt(qtyInput.value) || 1;
          if (val > 1) qtyInput.value = val - 1;
        });
      }
      
      if (plusBtn) {
        plusBtn.addEventListener('click', () => {
          const val = parseInt(qtyInput.value) || 1;
          const max = parseInt(qtyInput.max) || 99;
          if (val < max) qtyInput.value = val + 1;
        });
      }
      
      // Products Carousel
      document.querySelectorAll('.products-carousel').forEach(carousel => {
        const track = carousel.querySelector('.products-carousel-track');
        const prevBtn = carousel.querySelector('.carousel-nav-prev');
        const nextBtn = carousel.querySelector('.carousel-nav-next');
        const cards = carousel.querySelectorAll('.product-card');
        let scrollAmount = 0;
        
        const getCardWidth = () => {
          const card = cards[0];
          if (!card) return 200;
          const style = window.getComputedStyle(card);
          return card.offsetWidth + parseInt(style.marginRight || 0);
        };
        
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            const cardWidth = getCardWidth();
            scrollAmount = Math.max(scrollAmount - cardWidth * 2, 0);
            track.scrollTo({ left: scrollAmount, behavior: 'smooth' });
          });
        }
        
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            const cardWidth = getCardWidth();
            const maxScroll = track.scrollWidth - track.clientWidth;
            scrollAmount = Math.min(scrollAmount + cardWidth * 2, maxScroll);
            track.scrollTo({ left: scrollAmount, behavior: 'smooth' });
          });
        }
      });
    });
    
    // Add to cart function using data attributes
    function addToCartFromData(button) {
      const productId = button.dataset.productId;
      const productName = button.dataset.productName;
      const productPrice = parseFloat(button.dataset.productPrice);
      const productImage = button.dataset.productImage;
      
      // Get quantity if available (for main product button)
      const qtyInput = document.getElementById('product-qty');
      const quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
      
      addToCart(button, productId, productName, productPrice, productImage, quantity);
    }
  </script>
</body>
</html>
