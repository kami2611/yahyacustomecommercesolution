<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X89R61XJJ1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-X89R61XJJ1');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('../partials/seo-head') %>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/home.css">
  <link rel="stylesheet" href="/css/category.css">
  <script src="/js/theme.js"></script>
  <style>
    .brand-hero {
      position: relative;
      height: 200px;
      margin-bottom: 30px;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .brand-hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .brand-hero-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      font-size: 4rem;
      font-weight: bold;
    }
    
    .brand-hero-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 30px;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      color: white;
    }
    
    .brand-hero h1 {
      font-size: 2.5rem;
      margin: 0 0 8px;
    }
    
    .brand-hero p {
      margin: 0;
      opacity: 0.9;
      max-width: 600px;
    }
    
    @media (max-width: 768px) {
      .brand-hero {
        height: 160px;
      }
      
      .brand-hero h1 {
        font-size: 1.75rem;
      }
      
      .brand-hero-overlay {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <%- include('../partials/header') %>
  
  <%- include('../partials/mega-nav') %>
  
  <main class="category-page">
    <div class="container">
      <!-- Breadcrumbs -->
      <%- include('../partials/breadcrumbs', { breadcrumbs: breadcrumbs }) %>
      
      <!-- Brand Hero -->
      <div class="brand-hero">
        <% if (brand.backgroundImage) { %>
          <img src="<%= brand.backgroundImage %>" alt="<%= brand.name %>" class="brand-hero-image"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
          <div class="brand-hero-placeholder" style="display: none;">
            <%= brand.name.charAt(0).toUpperCase() %>
          </div>
        <% } else { %>
          <div class="brand-hero-placeholder">
            <%= brand.name.charAt(0).toUpperCase() %>
          </div>
        <% } %>
        <div class="brand-hero-overlay">
          <h1><%= brand.name %></h1>
          <% if (brand.description) { %>
            <p><%= brand.description %></p>
          <% } %>
        </div>
      </div>
      
      <div class="category-layout">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar">
          <div class="filter-header-mobile">
            <button class="filter-toggle" id="filter-toggle">
              <span>Filters</span>
              <span class="filter-icon">☰</span>
            </button>
          </div>
          
          <div class="filter-content" id="filter-content">
            <form action="/shop/brand/<%= brand.slug %>" method="GET" id="filter-form">
              <input type="hidden" name="sort" value="<%= filters.sort %>">
              
              <!-- Price Filter -->
              <div class="filter-section">
                <h3>Price</h3>
                <div class="price-inputs">
                  <input type="number" name="minPrice" placeholder="Min" 
                         value="<%= filters.minPrice %>" min="0" class="price-input">
                  <span>-</span>
                  <input type="number" name="maxPrice" placeholder="Max" 
                         value="<%= filters.maxPrice %>" min="0" class="price-input">
                </div>
              </div>
              
              <!-- Dynamic Attribute Filters -->
              <% if (typeof attributeFilters !== 'undefined' && attributeFilters && attributeFilters.length > 0) { %>
                <% attributeFilters.forEach(attr => { %>
                  <div class="filter-section">
                    <h3><%= attr.label %></h3>
                    <% if (attr.fieldType === 'select' || attr.availableValues.length > 0) { %>
                      <select name="attr[<%= attr.key %>]" class="attribute-select">
                        <option value="">All <%= attr.label %></option>
                        <% attr.availableValues.forEach(val => { %>
                          <option value="<%= val %>" <%= filters.attributes && filters.attributes[attr.key] === val ? 'selected' : '' %>><%= val %></option>
                        <% }) %>
                      </select>
                    <% } else { %>
                      <input type="text" name="attr[<%= attr.key %>]" 
                             placeholder="Filter by <%= attr.label.toLowerCase() %>"
                             value="<%= filters.attributes && filters.attributes[attr.key] ? filters.attributes[attr.key] : '' %>"
                             class="attribute-input">
                    <% } %>
                  </div>
                <% }) %>
              <% } %>
              
              <button type="submit" class="btn-apply-filter">Apply Filters</button>
              
              <% 
                const hasActiveFilters = filters.minPrice || filters.maxPrice || 
                  (filters.attributes && Object.values(filters.attributes).some(v => v));
              %>
              <% if (hasActiveFilters) { %>
                <a href="/shop/brand/<%= brand.slug %>" class="btn-clear-filters">Clear All Filters</a>
              <% } %>
            </form>
          </div>
        </aside>
        
        <!-- Products Main -->
        <div class="products-main">
          <!-- Sort & Results -->
          <div class="products-toolbar">
            <div class="results-count">
              <%= pagination.totalProducts %> product<%= pagination.totalProducts !== 1 ? 's' : '' %> found
            </div>
            
            <div class="sort-options">
              <label for="sort-select">Sort by:</label>
              <select id="sort-select" onchange="updateSort(this.value)">
                <option value="newest" <%= filters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                <option value="price-low" <%= filters.sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                <option value="price-high" <%= filters.sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                <option value="name-az" <%= filters.sort === 'name-az' ? 'selected' : '' %>>Name: A to Z</option>
                <option value="name-za" <%= filters.sort === 'name-za' ? 'selected' : '' %>>Name: Z to A</option>
              </select>
            </div>
          </div>
          
          <!-- Products Grid -->
          <% if (products && products.length > 0) { %>
            <div class="products-grid">
              <% products.forEach(product => { %>
                <div class="product-card">
                  <div class="product-image">
                    <a href="/product/<%= product.slug %>">
                      <img src="<%= product.images && product.images.length > 0 ? product.images[0] : '/images/placeholder.png' %>" 
                           alt="<%= product.name %>"
                           onerror="this.src='/images/placeholder.png'">
                    </a>
                    <% if (product.originalPrice && product.originalPrice > product.price) { %>
                      <span class="discount-badge">
                        <%= Math.round((1 - product.price / product.originalPrice) * 100) %>% OFF
                      </span>
                    <% } %>
                  </div>
                  <div class="product-details">
                    <h3 class="product-name">
                      <a href="/product/<%= product.slug %>"><%= product.name %></a>
                    </h3>
                    <div class="product-pricing">
                      <span class="current-price">Rs <%= product.price.toLocaleString() %></span>
                      <% if (product.originalPrice && product.originalPrice > product.price) { %>
                        <span class="original-price"><%= product.originalPrice.toLocaleString() %></span>
                      <% } %>
                    </div>
                   
                    <button class="btn-add-to-cart" 
                            data-product-id="<%= product._id %>"
                            onclick="addToCart(this, '<%= product._id %>', '<%= product.name.replace(/'/g, "\\'") %>', <%= product.price %>, '<%= product.images && product.images.length > 0 ? product.images[0] : '/images/placeholder.png' %>')">
                      Add to Basket
                    </button>
                  </div>
                </div>
              <% }) %>
            </div>
            
            <!-- Pagination -->
            <% if (pagination.totalPages > 1) { %>
              <%
                function buildPaginationUrl(pageNum) {
                  let url = `?page=${pageNum}&sort=${filters.sort}`;
                  if (filters.minPrice) url += `&minPrice=${filters.minPrice}`;
                  if (filters.maxPrice) url += `&maxPrice=${filters.maxPrice}`;
                  if (filters.attributes) {
                    Object.entries(filters.attributes).forEach(([key, val]) => {
                      if (val) url += `&attr[${key}]=${encodeURIComponent(val)}`;
                    });
                  }
                  return url;
                }
              %>
              <div class="pagination">
                <% if (pagination.hasPrev) { %>
                  <a href="<%= buildPaginationUrl(pagination.currentPage - 1) %>" class="page-link prev">
                    ← Previous
                  </a>
                <% } %>
                
                <div class="page-numbers">
                  <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                    <% if (i === pagination.currentPage) { %>
                      <span class="page-link current"><%= i %></span>
                    <% } else if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) { %>
                      <a href="<%= buildPaginationUrl(i) %>" class="page-link"><%= i %></a>
                    <% } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) { %>
                      <span class="page-ellipsis">...</span>
                    <% } %>
                  <% } %>
                </div>
                
                <% if (pagination.hasNext) { %>
                  <a href="<%= buildPaginationUrl(pagination.currentPage + 1) %>" class="page-link next">
                    Next →
                  </a>
                <% } %>
              </div>
            <% } %>
            
          <% } else { %>
            <div class="no-products">
              <p>No products found for this brand.</p>
              <a href="/shop/brands" class="btn btn-primary">Browse All Brands</a>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>
  
  <%- include('../partials/footer') %>
  
  <script>
    // Sort functionality
    function updateSort(value) {
      const url = new URL(window.location);
      url.searchParams.set('sort', value);
      url.searchParams.set('page', '1');
      window.location = url;
    }
    
    // Mobile filter toggle
    document.addEventListener('DOMContentLoaded', function() {
      const filterToggle = document.getElementById('filter-toggle');
      const filterContent = document.getElementById('filter-content');
      
      if (filterToggle) {
        filterToggle.addEventListener('click', function() {
          filterContent.classList.toggle('active');
        });
      }
    });
  </script>
  
  <%- include('../partials/cart-popup') %>
</body>
</html>
