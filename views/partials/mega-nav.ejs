<nav class="mega-nav">
  <div class="container">
    <ul class="nav-categories">
      <% if (typeof categories !== 'undefined' && categories) { %>
        <% 
          // Get only root categories (level 0)
          const rootCategories = categories.filter(cat => cat.level === 0);
        %>
        <% rootCategories.forEach(category => { %>
          <% 
            // Get direct children of THIS category by matching parent (not parentId)
            const children = categories.filter(cat => cat.parent && cat.parent.toString() === category._id.toString());
          %>
          <li class="nav-category-item" data-category-id="<%= category._id %>">
            <a href="/category/<%= category.slug %>" class="nav-category-link">
              <%= category.name %>
              <% if (children.length > 0) { %><span class="nav-arrow">â–¼</span><% } %>
            </a>
            
            <% if (children.length > 0) { %>
              <div class="mega-dropdown">
                <div class="mega-dropdown-content">
                  <% children.forEach(child => { %>
                    <% 
                      // Get grandchildren of THIS child
                      const grandchildren = categories.filter(cat => cat.parent && cat.parent.toString() === child._id.toString());
                    %>
                    <div class="mega-column">
                      <a href="/category/<%= child.slug %>" class="mega-column-title">
                        <%= child.name %>
                      </a>
                      <% if (grandchildren.length > 0) { %>
                        <ul class="mega-subcategories">
                          <% grandchildren.forEach(grandchild => { %>
                            <li>
                              <a href="/category/<%= grandchild.slug %>"><%= grandchild.name %></a>
                            </li>
                          <% }) %>
                        </ul>
                      <% } %>
                    </div>
                  <% }) %>
                </div>
              </div>
            <% } %>
          </li>
        <% }) %>
      <% } %>
    </ul>
  </div>
</nav>
