<!-- Cart Popup Modal -->
<div class="cart-popup-overlay" id="cart-popup-overlay">
  <div class="cart-popup">
    <button class="cart-popup-close" id="cart-popup-close" aria-label="Close">✕</button>
    
    <div class="cart-popup-content">
      <!-- Success Message -->
      <div class="cart-popup-header">
        <span class="success-icon">✓</span>
        <h2>Added to Basket</h2>
      </div>
      
      <!-- Added Item -->
      <div class="cart-popup-item" id="cart-popup-item">
        <div class="popup-item-image">
          <img src="/images/placeholder.png" alt="" id="popup-item-img">
        </div>
        <div class="popup-item-details">
          <h3 id="popup-item-name">Product Name</h3>
          <p class="popup-item-price" id="popup-item-price">Rs 0</p>
        <p class="popup-item-qty" id="popup-item-qty">Qty: 1</p>
        </div>
      </div>
      
      <!-- Cart Summary -->
      <div class="cart-popup-summary">
        <div class="summary-line">
          <span>Basket Subtotal (<span id="popup-cart-count">0</span> items)</span>
          <span id="popup-cart-total">Rs 0</span>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="cart-popup-actions">
        <a href="/cart" class="btn-view-basket">View Basket</a>
        <button class="btn-continue-shopping" id="btn-continue-shopping">Continue Shopping</button>
      </div>
      
      <!-- You May Also Like Section -->
      <div class="cart-popup-recommendations" id="cart-popup-recommendations">
        <h3>You may also like</h3>
        <div class="popup-products-grid" id="popup-products-grid">
          <!-- Products will be loaded dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Cart Popup Styles */
.cart-popup-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.cart-popup-overlay.active {
  display: flex;
}

.cart-popup {
  background: #fff;
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: popupSlideIn 0.3s ease;
}

@keyframes popupSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.cart-popup-close {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 32px;
  height: 32px;
  background: #f5f5f5;
  border: none;
  border-radius: 50%;
  font-size: 1.2rem;
  cursor: pointer;
  z-index: 10;
  transition: background 0.2s;
}

.cart-popup-close:hover {
  background: #e0e0e0;
}

.cart-popup-content {
  padding: 25px;
}

.cart-popup-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

.success-icon {
  width: 40px;
  height: 40px;
  background: #2a7d2e;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.cart-popup-header h2 {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

/* Added Item */
.cart-popup-item {
  display: flex;
  gap: 15px;
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}

.popup-item-image {
  width: 80px;
  height: 80px;
  background: #f5f5f5;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
}

.popup-item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.popup-item-details {
  flex: 1;
}

.popup-item-details h3 {
  font-size: 0.95rem;
  font-weight: 500;
  color: #333;
  margin: 0 0 8px 0;
  line-height: 1.3;
}

.popup-item-price {
  font-size: 1rem;
  font-weight: 700;
  color: #035751;
  margin: 0 0 5px 0;
}

.popup-item-qty {
  font-size: 0.85rem;
  color: #666;
  margin: 0;
}

/* Cart Summary */
.cart-popup-summary {
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}

.summary-line {
  display: flex;
  justify-content: space-between;
  font-weight: 600;
  color: #333;
}

/* Action Buttons */
.cart-popup-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 20px 0;
}

.btn-view-basket {
  display: block;
  padding: 14px 20px;
  background: #035751;
  color: #fff;
  text-align: center;
  text-decoration: none;
  border-radius: 30px;
  font-weight: 600;
  transition: background 0.3s;
}



.btn-continue-shopping {
  padding: 14px 20px;
  background: #fff;
  color: #035751;
  border: 2px solid #035751;
  border-radius: 30px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-continue-shopping:hover {
  background: #f5f0f4;
}

/* Recommendations */
.cart-popup-recommendations {
  padding-top: 15px;
}

.cart-popup-recommendations h3 {
  font-size: 1rem;
  font-weight: 600;
  color: #035751;
  margin: 0 0 15px 0;
}

.popup-products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.popup-product-card {
  background: #f9f9f9;
  border-radius: 8px;
  overflow: hidden;
}

.popup-product-card .popup-card-image {
  aspect-ratio: 1/1;
  background: #eee;
  overflow: hidden;
}

.popup-product-card .popup-card-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.popup-product-card .popup-card-info {
  padding: 10px;
}

.popup-product-card .popup-card-title {
  font-size: 0.8rem;
  font-weight: 500;
  color: #333;
  margin: 0 0 5px 0;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.popup-product-card .popup-card-title a {
  color: inherit;
  text-decoration: none;
}

.popup-product-card .popup-card-price {
  font-size: 0.9rem;
  font-weight: 700;
  color: #035751;
  margin: 0 0 8px 0;
}

.popup-product-card .btn-popup-add {
  width: 100%;
  padding: 8px;
  background: #035751;
  color: #fff;
  border: none;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}

.popup-product-card .btn-popup-add:hover {
  background: #5a2550;
}

/* Loading State for Add to Cart Button */
.btn-add-to-cart.loading,
.btn-add-to-cart-small.loading {
  position: relative;
  color: transparent !important;
  pointer-events: none;
}

.btn-add-to-cart.loading::after,
.btn-add-to-cart-small.loading::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  top: 50%;
  left: 50%;
  margin-top: -10px;
  margin-left: -10px;
  border: 2px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spinner 0.8s linear infinite;
}

@keyframes spinner {
  to {
    transform: rotate(360deg);
  }
}

.btn-add-to-cart.added,
.btn-add-to-cart-small.added {
  background: #2a7d2e !important;
}

/* Tablet */
@media (min-width: 768px) {
  .cart-popup {
    max-width: 550px;
  }
  
  .popup-products-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Dark Mode Overrides for Cart Popup */
[data-theme="dark"] .cart-popup {
  background: #000000;
  color: #ffffff;
  border: 1px solid #333333;
}

[data-theme="dark"] .cart-popup-content {
  background: #000000;
}

[data-theme="dark"] .cart-popup-header {
  border-bottom-color: #333333;
}

[data-theme="dark"] .success-icon {
  background: var(--accent-color);
  color: #000000;
}

[data-theme="dark"] .popup-item-image {
  background: #111111;
}

[data-theme="dark"] .popup-item-details h3 {
  color: #ffffff;
}

[data-theme="dark"] .popup-item-price {
  color: var(--accent-color);
}

[data-theme="dark"] .popup-item-qty {
  color: #dddddd;
}

[data-theme="dark"] .cart-popup-summary {
  border-bottom-color: #333333;
}

[data-theme="dark"] .summary-line {
  color: #ffffff;
}

[data-theme="dark"] .cart-popup-actions .btn-view-basket,
[data-theme="dark"] .cart-popup-actions .btn-continue-shopping {
  background: #000000;
  color: #ffffff;
  border: 2px solid var(--accent-color);
}

[data-theme="dark"] .cart-popup-actions .btn-view-basket:hover,
[data-theme="dark"] .cart-popup-actions .btn-continue-shopping:hover {
  background: var(--accent-color);
  color: #000000;
}

[data-theme="dark"] .cart-popup-close {
  background: #000000;
  color: #ffffff;
  border: 1px solid var(--accent-color);
}

[data-theme="dark"] .cart-popup-close:hover {
  background: var(--accent-color);
  color: #000000;
}

[data-theme="dark"] .cart-popup-recommendations h3 {
  color: var(--accent-color);
}

[data-theme="dark"] .popup-product-card {
  background: #000000;
  border: 1px solid #222222;
}

[data-theme="dark"] .popup-card-image {
  background: #111111;
}

[data-theme="dark"] .popup-card-title {
  color: #ffffff;
}

[data-theme="dark"] .popup-card-price {
  color: var(--accent-color);
}

[data-theme="dark"] .btn-popup-add {
  background: #000000;
  color: #ffffff;
  border: 2px solid var(--accent-color);
}

[data-theme="dark"] .btn-popup-add:hover {
  background: var(--accent-color);
  color: #000000;
}
</style>

<script>
// Cart Popup Functionality
(function() {
  const overlay = document.getElementById('cart-popup-overlay');
  const closeBtn = document.getElementById('cart-popup-close');
  const continueBtn = document.getElementById('btn-continue-shopping');
  
  // Close popup function
  function closePopup() {
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Close events
  if (closeBtn) closeBtn.addEventListener('click', closePopup);
  if (continueBtn) continueBtn.addEventListener('click', closePopup);
  if (overlay) {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) closePopup();
    });
  }
  
  // Escape key to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.classList.contains('active')) {
      closePopup();
    }
  });
  
  // Show popup function
  window.showCartPopup = async function(product, quantity = 1) {
    // Update popup with product info
    document.getElementById('popup-item-img').src = product.image || '/images/placeholder.png';
    document.getElementById('popup-item-img').alt = product.name;
    document.getElementById('popup-item-name').textContent = product.name;
    document.getElementById('popup-item-price').textContent = 'Rs ' + product.price.toLocaleString();
    document.getElementById('popup-item-qty').textContent = 'Qty: ' + quantity;
    
    // Calculate cart totals
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    document.getElementById('popup-cart-count').textContent = totalItems;
    
    // Fetch cart total (need product prices)
    try {
      if (cart.length > 0) {
        const productIds = cart.map(item => item.productId);
        const response = await fetch('/api/products/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: productIds })
        });
        
        if (response.ok) {
          const products = await response.json();
          const total = cart.reduce((sum, cartItem) => {
            const prod = products.find(p => p._id === cartItem.productId);
            return sum + (prod ? prod.price * cartItem.quantity : 0);
          }, 0);
          document.getElementById('popup-cart-total').textContent = 'Rs ' + total.toLocaleString();
        }
      }
    } catch (error) {
      console.error('Error fetching cart total:', error);
    }
    
    // Load recommendations
    loadRecommendations(product.id);
    
    // Show popup
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  };
  
  // Load recommendations
  async function loadRecommendations(currentProductId) {
    const grid = document.getElementById('popup-products-grid');
    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Loading...</p>';
    
    try {
      const response = await fetch('/api/products?limit=6');
      if (response.ok) {
        const data = await response.json();
        const products = (data.products || []).filter(p => p._id !== currentProductId).slice(0, 4);
        
        if (products.length > 0) {
          grid.innerHTML = products.map(p => `
            <div class="popup-product-card">
              <div class="popup-card-image">
                <a href="/product/${p.slug}">
                  <img src="${p.images && p.images.length > 0 ? p.images[0] : '/images/placeholder.png'}" 
                       alt="${p.name}"
                       onerror="this.src='/images/placeholder.png'">
                </a>
              </div>
              <div class="popup-card-info">
                <h4 class="popup-card-title">
                  <a href="/product/${p.slug}">${p.name}</a>
                </h4>
                <p class="popup-card-price">Rs ${p.price.toLocaleString()}</p>
                <button class="btn-popup-add" onclick="addToCartFromPopup('${p._id}', '${p.name.replace(/'/g, "\\'")}', ${p.price}, '${p.images && p.images.length > 0 ? p.images[0] : '/images/placeholder.png'}')">
                  Add to Basket
                </button>
              </div>
            </div>
          `).join('');
        } else {
          grid.innerHTML = '';
        }
      }
    } catch (error) {
      console.error('Error loading recommendations:', error);
      grid.innerHTML = '';
    }
  }
  
  // Add to cart from popup recommendations
  window.addToCartFromPopup = function(productId, name, price, image) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existingItem = cart.find(item => item.productId === productId);
    
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cart.push({ productId, quantity: 1 });
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Update popup
    showCartPopup({ id: productId, name, price, image }, 1);
  };
  
  // Main add to cart function
  window.addToCart = function(button, productId, name, price, image) {
    // Show loading state
    button.classList.add('loading');
    const originalHTML = button.innerHTML;
    
    setTimeout(function() {
      // Get quantity (default 1, or from input if on product page)
      let quantity = 1;
      const qtyInput = document.getElementById('product-qty');
      if (qtyInput) {
        quantity = parseInt(qtyInput.value) || 1;
      }
      
      // Add to cart
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existingItem = cart.find(item => item.productId === productId);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({ productId, quantity });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Show added state
      button.classList.remove('loading');
      button.classList.add('added');
      button.innerHTML = '<span>✓</span> Added!';
      
      // Show popup
      showCartPopup({ id: productId, name, price, image }, quantity);
      
      // Reset button after delay
      setTimeout(function() {
        button.classList.remove('added');
        button.innerHTML = originalHTML;
      }, 2000);
    }, 600);
  };
})();
</script>
